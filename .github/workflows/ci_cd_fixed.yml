# .github/workflows/ci_cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

env:
  FLUTTER_VERSION: '3.35.4'
  BUNDLE_ID_ANDROID: ${{ secrets.BUNDLE_ID_ANDROID || 'com.suleymansurucu.sarababy' }}
  BUNDLE_ID_IOS: ${{ secrets.BUNDLE_ID_IOS || 'com.suleymansurucu.babysara' }}
  SUPPORTED_LOCALES: ${{ secrets.SUPPORTED_LOCALES || 'en-US,tr-TR,ar-SA,de-DE,es-ES,fr-FR,id-ID,ko-KR,nl-NL,ru-RU,zh-TW' }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          
          # Ensure Android drawable resources exist
          echo "Setting up Android drawable resources..."
          mkdir -p android/app/src/main/res/drawable-v21
          if [ -f "android/app/src/main/res/drawable/background.png" ]; then
            cp android/app/src/main/res/drawable/background.png android/app/src/main/res/drawable-v21/background.png
            echo "background.png copied to drawable-v21"
          fi
          if [ -f "android/app/src/main/res/drawable/splash.png" ]; then
            cp android/app/src/main/res/drawable/splash.png android/app/src/main/res/drawable-v21/splash.png
            echo "splash.png copied to drawable-v21"
          fi
          
          # Check if firebase_options.dart exists and is valid
          if [ -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart already exists"
            # Validate the file has proper content
            if grep -q "DefaultFirebaseOptions" lib/firebase_options.dart; then
              echo "firebase_options.dart is valid"
            else
              echo "firebase_options.dart is invalid, will be regenerated"
              rm lib/firebase_options.dart
            fi
          fi
          
          # Only create if it doesn't exist or is invalid
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "Creating firebase_options.dart with fallback values..."
            mkdir -p lib
            cat > lib/firebase_options.dart << 'EOF'
// File generated by FlutterFire CLI.
// ignore_for_file: type=lint
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;

/// Default [FirebaseOptions] for use with your Firebase apps.
class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      case TargetPlatform.iOS:
        return ios;
      case TargetPlatform.macOS:
        return macos;
      case TargetPlatform.windows:
        return windows;
      case TargetPlatform.linux:
        throw UnsupportedError(
          'DefaultFirebaseOptions have not been configured for linux - '
          'you can reconfigure this by running the FlutterFire CLI again.',
        );
      default:
        throw UnsupportedError(
          'DefaultFirebaseOptions are not supported for this platform.',
        );
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyDUJbiFTgh1lpyzBbMWmsCV6baU922IHgM',
    appId: '1:880549897239:web:f0df90dbb5acec6a452852',
    messagingSenderId: '880549897239',
    projectId: 'baby-sara',
    authDomain: 'baby-sara.firebaseapp.com',
    storageBucket: 'baby-sara.firebasestorage.app',
    measurementId: 'G-YD9TT8VLTS',
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyAl7frXlsgKknlL-65TcHhKV0WaWqg8gI0',
    appId: '1:880549897239:android:56319d3d2748a31c452852',
    messagingSenderId: '880549897239',
    projectId: 'baby-sara',
    storageBucket: 'baby-sara.firebasestorage.app',
  );

  static const FirebaseOptions ios = FirebaseOptions(
    apiKey: 'AIzaSyAGPmYmUF4xihsi2qybToeznBj-_2tcDUE',
    appId: '1:880549897239:ios:d112ec4a34ec5397452852',
    messagingSenderId: '880549897239',
    projectId: 'baby-sara',
    storageBucket: 'baby-sara.firebasestorage.app',
    iosBundleId: 'com.suleymansurucu.babysara',
  );

  static const FirebaseOptions macos = FirebaseOptions(
    apiKey: 'AIzaSyAGPmYmUF4xihsi2qybToeznBj-_2tcDUE',
    appId: '1:880549897239:ios:9f96a92d2fe3cf93452852',
    messagingSenderId: '880549897239',
    projectId: 'baby-sara',
    storageBucket: 'baby-sara.firebasestorage.app',
    iosBundleId: 'com.example.flutterSaraBabyTrackerAndSound',
  );

  static const FirebaseOptions windows = FirebaseOptions(
    apiKey: 'AIzaSyDUJbiFTgh1lpyzBbMWmsCV6baU922IHgM',
    appId: '1:880549897239:web:cdd3e2a7b43f012a452852',
    messagingSenderId: '880549897239',
    projectId: 'baby-sara',
    authDomain: 'baby-sara.firebaseapp.com',
    storageBucket: 'baby-sara.firebasestorage.app',
    measurementId: 'G-QLXCXJJY9Z',
  );
}
EOF
            echo "firebase_options.dart created with fallback values"
          fi

      # Validate localization files
      - name: Validate localization files
        run: |
          echo "Validating localization files..."
          for locale in $(echo "${{ env.SUPPORTED_LOCALES }}" | tr ',' ' '); do
            if [ -f "lib/l10n/${locale}.json" ]; then
              echo "Found: ${locale}.json"
              python3 -m json.tool "lib/l10n/${locale}.json" > /dev/null
            else
              echo "Missing: ${locale}.json"
              exit 1
            fi
          done
          echo "All localization files are valid!"

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info

      - name: Analyze code
        run: |
          echo "Analyzing code..."
          flutter analyze || true
          echo "Code analysis completed (warnings are acceptable)"

      - name: Format code
        run: |
          echo "Formatting code..."
          dart format .
          echo "Code formatting completed"

  # Development build for develop branch
  build-development:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          
          # Ensure Android drawable resources exist
          echo "Setting up Android drawable resources..."
          mkdir -p android/app/src/main/res/drawable-v21
          if [ -f "android/app/src/main/res/drawable/background.png" ]; then
            cp android/app/src/main/res/drawable/background.png android/app/src/main/res/drawable-v21/background.png
            echo "background.png copied to drawable-v21"
          fi
          if [ -f "android/app/src/main/res/drawable/splash.png" ]; then
            cp android/app/src/main/res/drawable/splash.png android/app/src/main/res/drawable-v21/splash.png
            echo "splash.png copied to drawable-v21"
          fi
          
          # Create google-services.json if it doesn't exist
          if [ ! -f "android/app/google-services.json" ]; then
            echo "Creating google-services.json..."
            mkdir -p android/app
            cat > android/app/google-services.json << 'EOF'
{
  "project_info": {
    "project_number": "880549897239",
    "project_id": "baby-sara",
    "storage_bucket": "baby-sara.firebasestorage.app"
  },
  "client": [
    {
      "client_info": {
        "mobilesdk_app_id": "1:880549897239:android:56319d3d2748a31c452852",
        "android_client_info": {
          "package_name": "${{ env.BUNDLE_ID_ANDROID }}"
        }
      },
      "oauth_client": [],
      "api_key": [
        {
          "current_key": "AIzaSyAl7frXlsgKknlL-65TcHhKV0WaWqg8gI0"
        }
      ],
      "services": {
        "appinvite_service": {
          "other_platform_oauth_client": []
        }
      }
    }
  ],
  "configuration_version": "1"
}
EOF
            echo "google-services.json created"
          fi

      - name: Build Development APK
        run: |
          flutter build apk --debug \
            --build-name=dev-${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload Development APK
        uses: actions/upload-artifact@v4
        with:
          name: android-development-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

      - name: Build Development App Bundle
        run: |
          flutter build appbundle --debug \
            --build-name=dev-${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload Development App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-development-bundle-${{ github.sha }}
          path: build/app/outputs/bundle/debug/app-debug.aab
          retention-days: 7

  # Production build for main branch and tags
  build-android:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          
          # Ensure Android drawable resources exist
          echo "Setting up Android drawable resources..."
          mkdir -p android/app/src/main/res/drawable-v21
          if [ -f "android/app/src/main/res/drawable/background.png" ]; then
            cp android/app/src/main/res/drawable/background.png android/app/src/main/res/drawable-v21/background.png
            echo "background.png copied to drawable-v21"
          fi
          if [ -f "android/app/src/main/res/drawable/splash.png" ]; then
            cp android/app/src/main/res/drawable/splash.png android/app/src/main/res/drawable-v21/splash.png
            echo "splash.png copied to drawable-v21"
          fi
          
          # Create google-services.json if it doesn't exist
          if [ ! -f "android/app/google-services.json" ]; then
            echo "Creating google-services.json..."
            mkdir -p android/app
            cat > android/app/google-services.json << 'EOF'
{
  "project_info": {
    "project_number": "880549897239",
    "project_id": "baby-sara",
    "storage_bucket": "baby-sara.firebasestorage.app"
  },
  "client": [
    {
      "client_info": {
        "mobilesdk_app_id": "1:880549897239:android:56319d3d2748a31c452852",
        "android_client_info": {
          "package_name": "${{ env.BUNDLE_ID_ANDROID }}"
        }
      },
      "oauth_client": [],
      "api_key": [
        {
          "current_key": "AIzaSyAl7frXlsgKknlL-65TcHhKV0WaWqg8gI0"
        }
      ],
      "services": {
        "appinvite_service": {
          "other_platform_oauth_client": []
        }
      }
    }
  ],
  "configuration_version": "1"
}
EOF
            echo "google-services.json created"
          fi

      - name: Decode keystore
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks

      - name: Create key.properties
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=keystore.jks" >> android/key.properties

      - name: Build App Bundle
        run: |
          if [ -f "android/key.properties" ]; then
            flutter build appbundle --release \
              --build-name=${{ github.event.head_commit.id }} \
              --build-number=${{ github.run_number }}
          else
            flutter build appbundle --debug \
              --build-name=${{ github.event.head_commit.id }} \
              --build-number=${{ github.run_number }}
          fi

      - name: Build APK
        run: |
          if [ -f "android/key.properties" ]; then
            flutter build apk --release \
              --build-name=${{ github.event.head_commit.id }} \
              --build-number=${{ github.run_number }}
          else
            flutter build apk --debug \
              --build-name=${{ github.event.head_commit.id }} \
              --build-number=${{ github.run_number }}
          fi

      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-app-bundle-${{ github.sha }}
          path: build/app/outputs/bundle/*/app-*.aab
          retention-days: 30

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-*.apk
          retention-days: 30

  # iOS production build and deployment for main branch and tags
  build-ios-production:
    needs: test
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          
          # Create GoogleService-Info.plist if it doesn't exist
          if [ ! -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "Creating GoogleService-Info.plist..."
            mkdir -p ios/Runner
            cat > ios/Runner/GoogleService-Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>API_KEY</key>
	<string>AIzaSyAGPmYmUF4xihsi2qybToeznBj-_2tcDUE</string>
	<key>GCM_SENDER_ID</key>
	<string>880549897239</string>
	<key>PLIST_VERSION</key>
	<string>1</string>
	<key>BUNDLE_ID</key>
	<string>${{ env.BUNDLE_ID_IOS }}</string>
	<key>PROJECT_ID</key>
	<string>baby-sara</string>
	<key>STORAGE_BUCKET</key>
	<string>baby-sara.firebasestorage.app</string>
	<key>IS_ADS_ENABLED</key>
	<false></false>
	<key>IS_ANALYTICS_ENABLED</key>
	<false></false>
	<key>IS_APPINVITE_ENABLED</key>
	<true></true>
	<key>IS_GCM_ENABLED</key>
	<true></true>
	<key>IS_SIGNIN_ENABLED</key>
	<true></true>
	<key>GOOGLE_APP_ID</key>
	<string>1:880549897239:ios:d112ec4a34ec5397452852</string>
</dict>
</plist>
EOF
            echo "GoogleService-Info.plist created"
          fi

      - name: Install Fastlane
        run: |
          cd ios
          bundle install

      # Setup API Key from secrets
      - name: Setup API Key
        if: ${{ secrets.APP_STORE_CONNECT_API_KEY != '' }}
        run: |
          cd ios
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID || 'T793NZB3B5' }}.p8

      - name: Build and Deploy iOS
        env:
          BUNDLE_ID_IOS: ${{ env.BUNDLE_ID_IOS }}
          APPLE_ID: ${{ secrets.APPLE_ID || 'suleymansurucu95@icloud.com' }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID || '3588AF9993' }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID || '3588AF9993' }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID || 'T793NZB3B5' }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID || 'bd3d7716-83ab-4e9a-9a30-a77ec9bc8b9f' }}
        run: |
          cd ios
          if [ -f "AuthKey_*.p8" ]; then
            bundle exec fastlane release
          else
            echo "No API key found, skipping deployment"
          fi

      - name: Upload iOS Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-build-${{ github.sha }}
          path: ios/build/
          retention-days: 30

  # iOS development build for develop branch
  build-ios-development:
    needs: test
    runs-on: macos-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          
          # Create GoogleService-Info.plist if it doesn't exist
          if [ ! -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "Creating GoogleService-Info.plist..."
            mkdir -p ios/Runner
            cat > ios/Runner/GoogleService-Info.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>API_KEY</key>
	<string>AIzaSyAGPmYmUF4xihsi2qybToeznBj-_2tcDUE</string>
	<key>GCM_SENDER_ID</key>
	<string>880549897239</string>
	<key>PLIST_VERSION</key>
	<string>1</string>
	<key>BUNDLE_ID</key>
	<string>${{ env.BUNDLE_ID_IOS }}</string>
	<key>PROJECT_ID</key>
	<string>baby-sara</string>
	<key>STORAGE_BUCKET</key>
	<string>baby-sara.firebasestorage.app</string>
	<key>IS_ADS_ENABLED</key>
	<false></false>
	<key>IS_ANALYTICS_ENABLED</key>
	<false></false>
	<key>IS_APPINVITE_ENABLED</key>
	<true></true>
	<key>IS_GCM_ENABLED</key>
	<true></true>
	<key>IS_SIGNIN_ENABLED</key>
	<true></true>
	<key>GOOGLE_APP_ID</key>
	<string>1:880549897239:ios:d112ec4a34ec5397452852</string>
</dict>
</plist>
EOF
            echo "GoogleService-Info.plist created"
          fi

      - name: Build iOS Development
        run: |
          cd ios
          flutter build ios --debug --no-codesign \
            --build-name=dev-${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload iOS Development Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-development-build-${{ github.sha }}
          path: build/ios/iphoneos/Runner.app
          retention-days: 7

  # Development build notification
  notify-development-build:
    needs: [build-development, build-ios-development]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Development Build Complete
        run: |
          echo "Development build completed successfully!"
          echo "Android APK and App Bundle are ready for testing"
          echo "iOS build is ready for testing"
          echo "Download artifacts from the Actions tab"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: develop"

  # iOS deployment notification
  notify-ios-deployment:
    needs: [build-ios-production]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: iOS Deployment Complete
        run: |
          echo "iOS deployment completed successfully!"
          echo "App uploaded to App Store Connect"
          echo "Check App Store Connect for processing status"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: main"

  # Android deployment
  deploy-android:
    needs: [build-android]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download App Bundle
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle-${{ github.sha }}
          path: .

      - name: Deploy to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.BUNDLE_ID_ANDROID }}
          releaseFiles: app-*.aab
          track: production
          status: completed
          inAppUpdatePriority: 2
          releaseNotes: |
            New version with improvements and bug fixes
            Enhanced user experience
            Performance optimizations