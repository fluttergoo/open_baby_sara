# .github/workflows/ci_cd.yml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

env:
  FLUTTER_VERSION: '3.35.4'
  BUNDLE_ID_ANDROID: ${{ secrets.BUNDLE_ID_ANDROID }}
  BUNDLE_ID_IOS: ${{ secrets.BUNDLE_ID_IOS }}
  SUPPORTED_LOCALES: ${{ secrets.SUPPORTED_LOCALES || 'en-US,tr-TR,ar-SA,de-DE,es-ES,fr-FR,id-ID,ko-KR,nl-NL,ru-RU,zh-TW' }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          # Check if firebase_options.dart exists
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart not found, creating minimal version..."
            mkdir -p lib
            echo "// File generated by FlutterFire CLI." > lib/firebase_options.dart
            echo "// ignore_for_file: type=lint" >> lib/firebase_options.dart
            echo "import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;" >> lib/firebase_options.dart
            echo "import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "/// Default [FirebaseOptions] for use with your Firebase apps." >> lib/firebase_options.dart
            echo "class DefaultFirebaseOptions {" >> lib/firebase_options.dart
            echo "  static FirebaseOptions get currentPlatform {" >> lib/firebase_options.dart
            echo "    if (kIsWeb) return web;" >> lib/firebase_options.dart
            echo "    switch (defaultTargetPlatform) {" >> lib/firebase_options.dart
            echo "      case TargetPlatform.android: return android;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.iOS: return ios;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.macOS: return macos;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.windows: return windows;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.linux: throw UnsupportedError('DefaultFirebaseOptions have not been configured for linux');" >> lib/firebase_options.dart
            echo "      default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform');" >> lib/firebase_options.dart
            echo "    }" >> lib/firebase_options.dart
            echo "  }" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions web = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WEB_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions android = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_ANDROID_API_KEY }}', appId: '${{ secrets.FIREBASE_ANDROID_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions ios = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_IOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions macos = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_MACOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions windows = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WINDOWS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "}" >> lib/firebase_options.dart
          else
            echo "firebase_options.dart already exists"
          fi
          
          # Ensure Android drawable resources exist
          echo "Setting up Android drawable resources..."
          mkdir -p android/app/src/main/res/drawable-v21
          if [ -f "android/app/src/main/res/drawable/background.png" ]; then
            cp android/app/src/main/res/drawable/background.png android/app/src/main/res/drawable-v21/background.png
            echo "background.png copied to drawable-v21"
          fi
          if [ -f "android/app/src/main/res/drawable/splash.png" ]; then
            cp android/app/src/main/res/drawable/splash.png android/app/src/main/res/drawable-v21/splash.png
            echo "splash.png copied to drawable-v21"
          fi

      # Validate localization files
      - name: Validate localization files
        run: |
          echo "Validating localization files..."
          for locale in $(echo "${{ env.SUPPORTED_LOCALES }}" | tr ',' ' '); do
            if [ -f "lib/l10n/${locale}.json" ]; then
              echo "Found: ${locale}.json"
              python3 -m json.tool "lib/l10n/${locale}.json" > /dev/null
            else
              echo "Missing: ${locale}.json"
              exit 1
            fi
          done
          echo "All localization files are valid!"

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info

      - name: Analyze code
        run: |
          echo "Analyzing code..."
          flutter analyze || true
          echo "Code analysis completed (warnings are acceptable)"

      - name: Format code
        run: |
          echo "Formatting code..."
          dart format .
          echo "Code formatting completed"

  # Development build for develop branch
  build-development:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          # Check if firebase_options.dart exists
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart not found, creating minimal version..."
            mkdir -p lib
            echo "// File generated by FlutterFire CLI." > lib/firebase_options.dart
            echo "// ignore_for_file: type=lint" >> lib/firebase_options.dart
            echo "import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;" >> lib/firebase_options.dart
            echo "import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "/// Default [FirebaseOptions] for use with your Firebase apps." >> lib/firebase_options.dart
            echo "class DefaultFirebaseOptions {" >> lib/firebase_options.dart
            echo "  static FirebaseOptions get currentPlatform {" >> lib/firebase_options.dart
            echo "    if (kIsWeb) return web;" >> lib/firebase_options.dart
            echo "    switch (defaultTargetPlatform) {" >> lib/firebase_options.dart
            echo "      case TargetPlatform.android: return android;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.iOS: return ios;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.macOS: return macos;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.windows: return windows;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.linux: throw UnsupportedError('DefaultFirebaseOptions have not been configured for linux');" >> lib/firebase_options.dart
            echo "      default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform');" >> lib/firebase_options.dart
            echo "    }" >> lib/firebase_options.dart
            echo "  }" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions web = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WEB_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions android = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_ANDROID_API_KEY }}', appId: '${{ secrets.FIREBASE_ANDROID_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions ios = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_IOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions macos = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_MACOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions windows = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WINDOWS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "}" >> lib/firebase_options.dart
          else
            echo "firebase_options.dart already exists"
          fi
          
          # Create google-services.json if it doesn't exist
          if [ ! -f "android/app/google-services.json" ]; then
            echo "google-services.json not found, creating minimal version..."
            mkdir -p android/app
            echo '{' > android/app/google-services.json
            echo '  "project_info": {' >> android/app/google-services.json
            echo '    "project_number": "'${{ secrets.FIREBASE_PROJECT_NUMBER }}'",' >> android/app/google-services.json
            echo '    "project_id": "'${{ secrets.FIREBASE_PROJECT_ID }}'",' >> android/app/google-services.json
            echo '    "storage_bucket": "'${{ secrets.FIREBASE_STORAGE_BUCKET }}'"' >> android/app/google-services.json
            echo '  },' >> android/app/google-services.json
            echo '  "client": [' >> android/app/google-services.json
            echo '    {' >> android/app/google-services.json
            echo '      "client_info": {' >> android/app/google-services.json
            echo '        "mobilesdk_app_id": "'${{ secrets.FIREBASE_ANDROID_APP_ID }}'",' >> android/app/google-services.json
            echo '        "android_client_info": {' >> android/app/google-services.json
            echo '          "package_name": "'${{ env.BUNDLE_ID_ANDROID }}'"' >> android/app/google-services.json
            echo '        }' >> android/app/google-services.json
            echo '      },' >> android/app/google-services.json
            echo '      "oauth_client": [],' >> android/app/google-services.json
            echo '      "api_key": [' >> android/app/google-services.json
            echo '        {' >> android/app/google-services.json
            echo '          "current_key": "'${{ secrets.FIREBASE_ANDROID_API_KEY }}'"' >> android/app/google-services.json
            echo '        }' >> android/app/google-services.json
            echo '      ],' >> android/app/google-services.json
            echo '      "services": {' >> android/app/google-services.json
            echo '        "appinvite_service": {' >> android/app/google-services.json
            echo '          "other_platform_oauth_client": []' >> android/app/google-services.json
            echo '        }' >> android/app/google-services.json
            echo '      }' >> android/app/google-services.json
            echo '    }' >> android/app/google-services.json
            echo '  ],' >> android/app/google-services.json
            echo '  "configuration_version": "1"' >> android/app/google-services.json
            echo '}' >> android/app/google-services.json
          fi
          
          # Ensure Android drawable resources exist
          echo "Setting up Android drawable resources..."
          mkdir -p android/app/src/main/res/drawable-v21
          if [ -f "android/app/src/main/res/drawable/background.png" ]; then
            cp android/app/src/main/res/drawable/background.png android/app/src/main/res/drawable-v21/background.png
            echo "background.png copied to drawable-v21"
          fi
          if [ -f "android/app/src/main/res/drawable/splash.png" ]; then
            cp android/app/src/main/res/drawable/splash.png android/app/src/main/res/drawable-v21/splash.png
            echo "splash.png copied to drawable-v21"
          fi

      - name: Build Development APK
        run: |
          flutter build apk --debug \
            --build-name=dev-${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload Development APK
        uses: actions/upload-artifact@v4
        with:
          name: android-development-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

      - name: Build Development App Bundle
        run: |
          flutter build appbundle --debug \
            --build-name=dev-${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload Development App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-development-bundle-${{ github.sha }}
          path: build/app/outputs/bundle/debug/app-debug.aab
          retention-days: 7

  # Production build for main branch and tags
  build-android:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          # Check if firebase_options.dart exists
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart not found, creating minimal version..."
            mkdir -p lib
            echo "// File generated by FlutterFire CLI." > lib/firebase_options.dart
            echo "// ignore_for_file: type=lint" >> lib/firebase_options.dart
            echo "import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;" >> lib/firebase_options.dart
            echo "import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "/// Default [FirebaseOptions] for use with your Firebase apps." >> lib/firebase_options.dart
            echo "class DefaultFirebaseOptions {" >> lib/firebase_options.dart
            echo "  static FirebaseOptions get currentPlatform {" >> lib/firebase_options.dart
            echo "    if (kIsWeb) return web;" >> lib/firebase_options.dart
            echo "    switch (defaultTargetPlatform) {" >> lib/firebase_options.dart
            echo "      case TargetPlatform.android: return android;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.iOS: return ios;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.macOS: return macos;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.windows: return windows;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.linux: throw UnsupportedError('DefaultFirebaseOptions have not been configured for linux');" >> lib/firebase_options.dart
            echo "      default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform');" >> lib/firebase_options.dart
            echo "    }" >> lib/firebase_options.dart
            echo "  }" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions web = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WEB_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions android = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_ANDROID_API_KEY }}', appId: '${{ secrets.FIREBASE_ANDROID_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions ios = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_IOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions macos = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_MACOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions windows = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WINDOWS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "}" >> lib/firebase_options.dart
          else
            echo "firebase_options.dart already exists"
          fi
          
          # Create google-services.json if it doesn't exist
          if [ ! -f "android/app/google-services.json" ]; then
            echo "google-services.json not found, creating minimal version..."
            mkdir -p android/app
            echo '{' > android/app/google-services.json
            echo '  "project_info": {' >> android/app/google-services.json
            echo '    "project_number": "'${{ secrets.FIREBASE_PROJECT_NUMBER }}'",' >> android/app/google-services.json
            echo '    "project_id": "'${{ secrets.FIREBASE_PROJECT_ID }}'",' >> android/app/google-services.json
            echo '    "storage_bucket": "'${{ secrets.FIREBASE_STORAGE_BUCKET }}'"' >> android/app/google-services.json
            echo '  },' >> android/app/google-services.json
            echo '  "client": [' >> android/app/google-services.json
            echo '    {' >> android/app/google-services.json
            echo '      "client_info": {' >> android/app/google-services.json
            echo '        "mobilesdk_app_id": "'${{ secrets.FIREBASE_ANDROID_APP_ID }}'",' >> android/app/google-services.json
            echo '        "android_client_info": {' >> android/app/google-services.json
            echo '          "package_name": "'${{ env.BUNDLE_ID_ANDROID }}'"' >> android/app/google-services.json
            echo '        }' >> android/app/google-services.json
            echo '      },' >> android/app/google-services.json
            echo '      "oauth_client": [],' >> android/app/google-services.json
            echo '      "api_key": [' >> android/app/google-services.json
            echo '        {' >> android/app/google-services.json
            echo '          "current_key": "'${{ secrets.FIREBASE_ANDROID_API_KEY }}'"' >> android/app/google-services.json
            echo '        }' >> android/app/google-services.json
            echo '      ],' >> android/app/google-services.json
            echo '      "services": {' >> android/app/google-services.json
            echo '        "appinvite_service": {' >> android/app/google-services.json
            echo '          "other_platform_oauth_client": []' >> android/app/google-services.json
            echo '        }' >> android/app/google-services.json
            echo '      }' >> android/app/google-services.json
            echo '    }' >> android/app/google-services.json
            echo '  ],' >> android/app/google-services.json
            echo '  "configuration_version": "1"' >> android/app/google-services.json
            echo '}' >> android/app/google-services.json
          fi
          
          # Ensure Android drawable resources exist
          echo "Setting up Android drawable resources..."
          mkdir -p android/app/src/main/res/drawable-v21
          if [ -f "android/app/src/main/res/drawable/background.png" ]; then
            cp android/app/src/main/res/drawable/background.png android/app/src/main/res/drawable-v21/background.png
            echo "background.png copied to drawable-v21"
          fi
          if [ -f "android/app/src/main/res/drawable/splash.png" ]; then
            cp android/app/src/main/res/drawable/splash.png android/app/src/main/res/drawable-v21/splash.png
            echo "splash.png copied to drawable-v21"
          fi

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=keystore.jks" >> android/key.properties

      - name: Build App Bundle
        run: |
          flutter build appbundle --release \
            --build-name=${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Build APK
        run: |
          flutter build apk --release \
            --build-name=${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-app-bundle-${{ github.sha }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  # iOS production build and deployment for main branch and tags
  build-ios-production:
    needs: test
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          echo "Current directory: $(pwd)"
          echo "Contents of current directory:"
          ls -la
          echo "Contents of lib directory:"
          ls -la lib/ || echo "lib directory does not exist"
          
          # Check if firebase_options.dart exists
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart not found, creating minimal version..."
            mkdir -p lib
            echo "// File generated by FlutterFire CLI." > lib/firebase_options.dart
            echo "// ignore_for_file: type=lint" >> lib/firebase_options.dart
            echo "import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;" >> lib/firebase_options.dart
            echo "import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "/// Default [FirebaseOptions] for use with your Firebase apps." >> lib/firebase_options.dart
            echo "class DefaultFirebaseOptions {" >> lib/firebase_options.dart
            echo "  static FirebaseOptions get currentPlatform {" >> lib/firebase_options.dart
            echo "    if (kIsWeb) return web;" >> lib/firebase_options.dart
            echo "    switch (defaultTargetPlatform) {" >> lib/firebase_options.dart
            echo "      case TargetPlatform.android: return android;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.iOS: return ios;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.macOS: return macos;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.windows: return windows;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.linux: throw UnsupportedError('DefaultFirebaseOptions have not been configured for linux');" >> lib/firebase_options.dart
            echo "      default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform');" >> lib/firebase_options.dart
            echo "    }" >> lib/firebase_options.dart
            echo "  }" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions web = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WEB_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions android = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_ANDROID_API_KEY }}', appId: '${{ secrets.FIREBASE_ANDROID_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions ios = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_IOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions macos = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_MACOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions windows = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WINDOWS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "}" >> lib/firebase_options.dart
            echo "firebase_options.dart created successfully"
          else
            echo "firebase_options.dart already exists"
          fi
          
          echo "Final contents of lib directory:"
          ls -la lib/
          echo "Contents of firebase_options.dart:"
          cat lib/firebase_options.dart
          
          # Create GoogleService-Info.plist if it doesn't exist
          if [ ! -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "GoogleService-Info.plist not found, creating minimal version..."
            mkdir -p ios/Runner
            echo '<?xml version="1.0" encoding="UTF-8"?>' > ios/Runner/GoogleService-Info.plist
            echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> ios/Runner/GoogleService-Info.plist
            echo '<plist version="1.0">' >> ios/Runner/GoogleService-Info.plist
            echo '<dict>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>API_KEY</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>'${{ secrets.FIREBASE_IOS_API_KEY }}'</string>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>GCM_SENDER_ID</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>'${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}'</string>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>PLIST_VERSION</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>1</string>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>BUNDLE_ID</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>'${{ env.BUNDLE_ID_IOS }}'</string>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>PROJECT_ID</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>'${{ secrets.FIREBASE_PROJECT_ID }}'</string>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>STORAGE_BUCKET</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>'${{ secrets.FIREBASE_STORAGE_BUCKET }}'</string>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>IS_ADS_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<false></false>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>IS_ANALYTICS_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<false></false>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>IS_APPINVITE_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<true></true>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>IS_GCM_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<true></true>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>IS_SIGNIN_ENABLED</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<true></true>' >> ios/Runner/GoogleService-Info.plist
            echo '	<key>GOOGLE_APP_ID</key>' >> ios/Runner/GoogleService-Info.plist
            echo '	<string>'${{ secrets.FIREBASE_IOS_APP_ID }}'</string>' >> ios/Runner/GoogleService-Info.plist
            echo '</dict>' >> ios/Runner/GoogleService-Info.plist
            echo '</plist>' >> ios/Runner/GoogleService-Info.plist
          fi

      - name: Install Fastlane
        run: |
          cd ios
          bundle install

      # Setup API Key from secrets
      - name: Setup API Key
        run: |
          cd ios
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: Build and Deploy iOS
        env:
          BUNDLE_ID_IOS: ${{ secrets.BUNDLE_ID_IOS }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_CONNECT_TEAM_ID: ${{ secrets.APP_STORE_CONNECT_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios
          bundle exec fastlane release

      - name: Upload iOS Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-build-${{ github.sha }}
          path: ios/build/
          retention-days: 30

  # iOS development build for develop branch
  build-ios-development:
    needs: test
    runs-on: macos-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.packages
            **/.flutter-plugins
            **/.flutter-plugin-dependencies
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      # Setup Firebase configuration
      - name: Setup Firebase configuration
        run: |
          echo "Setting up Firebase configuration..."
          # Check if firebase_options.dart exists
          if [ ! -f "lib/firebase_options.dart" ]; then
            echo "firebase_options.dart not found, creating minimal version..."
            mkdir -p lib
            echo "// File generated by FlutterFire CLI." > lib/firebase_options.dart
            echo "// ignore_for_file: type=lint" >> lib/firebase_options.dart
            echo "import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;" >> lib/firebase_options.dart
            echo "import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "/// Default [FirebaseOptions] for use with your Firebase apps." >> lib/firebase_options.dart
            echo "class DefaultFirebaseOptions {" >> lib/firebase_options.dart
            echo "  static FirebaseOptions get currentPlatform {" >> lib/firebase_options.dart
            echo "    if (kIsWeb) return web;" >> lib/firebase_options.dart
            echo "    switch (defaultTargetPlatform) {" >> lib/firebase_options.dart
            echo "      case TargetPlatform.android: return android;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.iOS: return ios;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.macOS: return macos;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.windows: return windows;" >> lib/firebase_options.dart
            echo "      case TargetPlatform.linux: throw UnsupportedError('DefaultFirebaseOptions have not been configured for linux');" >> lib/firebase_options.dart
            echo "      default: throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform');" >> lib/firebase_options.dart
            echo "    }" >> lib/firebase_options.dart
            echo "  }" >> lib/firebase_options.dart
            echo "" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions web = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WEB_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions android = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_ANDROID_API_KEY }}', appId: '${{ secrets.FIREBASE_ANDROID_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions ios = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_IOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions macos = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}', appId: '${{ secrets.FIREBASE_MACOS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "  static const FirebaseOptions windows = FirebaseOptions(apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}', appId: '${{ secrets.FIREBASE_WINDOWS_APP_ID }}', messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}', projectId: '${{ secrets.FIREBASE_PROJECT_ID }}');" >> lib/firebase_options.dart
            echo "}" >> lib/firebase_options.dart
          else
            echo "firebase_options.dart already exists"
          fi

      - name: Build iOS Development
        run: |
          cd ios
          flutter build ios --debug --no-codesign \
            --build-name=dev-${{ github.event.head_commit.id }} \
            --build-number=${{ github.run_number }}

      - name: Upload iOS Development Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-development-build-${{ github.sha }}
          path: build/ios/iphoneos/Runner.app
          retention-days: 7

  # Development build notification
  notify-development-build:
    needs: [build-development, build-ios-development]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Development Build Complete
        run: |
          echo "Development build completed successfully!"
          echo "Android APK and App Bundle are ready for testing"
          echo "iOS build is ready for testing"
          echo "Download artifacts from the Actions tab"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: develop"

  # iOS deployment notification
  notify-ios-deployment:
    needs: [build-ios-production]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: iOS Deployment Complete
        run: |
          echo "iOS deployment completed successfully!"
          echo "App uploaded to App Store Connect"
          echo "Check App Store Connect for processing status"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: main"

  # Android deployment
  deploy-android:
    needs: [build-android]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download App Bundle
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle-${{ github.sha }}
          path: .

      - name: Deploy to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.BUNDLE_ID_ANDROID }}
          releaseFiles: app-release.aab
          track: production
          status: completed
          inAppUpdatePriority: 2
          releaseNotes: |
            New version with improvements and bug fixes
            Enhanced user experience
            Performance optimizations
